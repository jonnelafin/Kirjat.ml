<!DOCTYPE html>
<html>
<head>
	<title>Kirjat.ml</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<meta charset="UTF-8">
	
	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
	<link rel="manifest" href="manifest.json">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
	
	<link rel="stylesheet" href="index.css">
</head>
<body>
	<div class="d-flex justify-content-center">
		<h1> Kirjat.ml </h1><br>
	</div>
	<div class="text-center">
		<p style="font-size:92%;" class="text-muted"> Nimi ja domain "Kirjat.ml" © Elias Eskelinen 2020, sivuston koodi on MIT-Lisenssin alainen. <a href="https://github.com/jonnelafin/Kirjat.ml/"> Lähdekoodi </a>, <a href="LICENSE"> Lisenssi </a></p>
    	<button class="btn btn-dark add-button">Add to home screen</button>
	</div>
	<div class="d-flex justify-content-center">
		<textarea cols=75 rows=7 onkeyup="fillLink()" onchange="fillLink()" placeholder="Kirjoita kirjojen nimet tähän, yksi per rivi.&#10;Esim:&#10;Bios 1 Elämä ja evoluutio&#10;Geos 1 Maailma muutoksessa&#10;Insights 2&#10;Tekijä Pitkä matematiikka 3&#10;Nos vemos 3" class="" id="input" ></textarea>
	</div>
	<div class="text-center">
		<p style="font-size:92%;" class="text-muted"> Haku saattaa toimia paremmin jos et kirjoita koko kirjan ja tekijän nimeä. <br>Esim. ei "Bios 1 Elämä ja evoluutio, Sanomapro" vaan "Bios 1" :)</p>
	</div>
	<br>
	<div class="text-center">
		<button class="btn btn-primary" onclick="query()"> Hae </button>
		<!-- <input type="number"/> Tulosten määrä </input> -->
	</div>
	<hr>
	<div class="container-fluid " id="results_original">
	</div>
	<hr>
	<div class=" container d-flex justify-content-center card">
	    <div class="card-body">
			<div class="text-center">
				<h3 id="finalHinta" class="card-title"> Yhteensä 0€ <h3/>
				<h4 id="finalHintaSub"> <h4/>
			</div>
	        <p class="card-description">Alta voit kopioda linkin tähän hakuun:</p> <input type="text" id="linkki" class="form-control" value="hello">
	        <div class="mt-3"> <button type="button" onclick="document.getElementById('kop').style.display='';" class="btn btn-info btn-clipboard" data-clipboard-action="copy" data-clipboard-target="#linkki">Kopio Linkki</button>  </div>
	        <p id="kop" style="display:none;"> Linkki kopioitu! </p>
	    </div>
    </div>
    <br \>
</body>
<footer>
<template id="cardTemplate">
	<div class="card text-center col-auto" style="width: 18rem;">
	  <img class="card-img-top jf-img" src="" alt="Ei kuvaa" id="card-img-top">
	  <div class="card-body" id="card-body">
		<h5 class="card-title" id="card-title">Card title</h5>
		<p class="card-text" id="card-text" style="margin-bottom: 0.1rem;">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
		<p class="card-text" id="card-text2" style="font-size:90%">Max 10€</p>
	  </div>
	  <div class="card-footer">
		<p class="card-text" id="card-text3" style="font-size:120%">10€</p>
		<div class="btn-group mr-2" role="group" aria-label="First group" id="buttons">
			<button type="button" class="btn btn-primary" id="btnNew" onclick="toggleB(this)">Uusi</button>
			<button type="button" class="btn btn-light" id="btnBlue" onclick="toggleB(this)">Sininen</button>
			<button type="button" class="btn btn-light" id="btnGreen" onclick="toggleB(this)">Vihreä</button>
			<button type="button" class="btn btn-success" id="btnSelect" onclick="toggleB2(this)">-</button>
		</div>
	  </div>
	</div>
</template>
<script>
	var results_max = 12;
	var pwa_enabled = false;
	function unclean(err){
		return err.replaceAll("%E4", "ä").replaceAll("%F6", "ö").replaceAll("%E5", "å");
	}
	function fillLink(){
		var val = genLink();
		document.getElementById('kop').style.display='none';
		document.getElementById("linkki").value = val;
	}
	function query() {
		fillLink();
		document.getElementById("results_original").innerHTML = "";
		var val = document.getElementById("input").value;
		val = val.replaceAll("\n\n", "\n");
		var lineC = countC(val, "\n");
		console.log(lineC);
		if(lineC > 0){
			if(val[val.size-1] === "\n"){
				val = val.substring(0, val.size-2);
			}
		}
		console.log(val)
		document.getElementById("input").rows = Math.min(7, lineC) + 2;
		let formData = new FormData();
		formData.append('querym', val);
		document.getElementById("results_original").appendChild(htmlToElement('<div class="mx-auto text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>Odotetaan vastausta palvelimelta... Tässä saattaa kestää hetki jos olet ensimmäinen käyttäjä vähään aikaan.</div>'));
		(async () => {
		  const rawResponse = await fetch('https://kirjat-ml.herokuapp.com/api/v1', {
			method: 'POST',
			headers: {
			},
			body: formData
		  });
		  const content = await rawResponse.json();

		  var stuff = content;
		  console.log(stuff);
		  var first_outer = true;
		  for(thing in stuff){
			var cont = stuff[thing]["data"];
			var collapsed = "collapsed";
			var collapse = "collapse";
			var down = "▾";
			if(first_outer === true){
				collapsed = "";
				collapse = "collapse show";
				down = "▴";
			}
			document.getElementById("results_original").appendChild(htmlToElement('<button class="btn ' + collapsed + ' mx-auto border-info m-1" style="width: 99%;font-size:110%;" data-toggle="collapse" data-target="#collapse' + thing + '" onclick="this.innerHTML = this.innerHTML.replaceAll(\'▾\', \'|\').replaceAll(\'▴\', \'▾\').replaceAll(\'|\', \'▴\');">' + down + ' ' + val.split("\n")[thing] + ' ' + down + "</button>"));
			document.getElementById("results_original").appendChild(htmlToElement('<div class="' + collapse + '  " id="collapse' + thing + '">'));
			document.getElementById('collapse' + thing + '').appendChild(htmlToElement('<div class="d-flex row flex-row flex-nowrap container-fluid mx-auto" id="results" style="overflow-x: auto;">'));
			var first = true;
			for(booko in cont.slice(0, results_max+1)){
				var book = cont[booko];
				var name = book["name"];
				var id = book["id"];
				var image = book["image"];
				var link = book["link"];
				var prices = book["prices"];
				var conditions = book["conditions"];
				var price = book["price"];
				if (price != -1){
					addCard(name, conditions, prices, image, book, first);
					first = false;
				}
			}
			if(stuff[thing]["err"] != ""){
				var results = document.querySelectorAll("#results");
				var tbody = results[results.length-1];
				tbody.appendChild(htmlToElement('<h4 class="text-center">' + unclean(stuff[thing]["err"]) + '</h4>'));
			}
			document.getElementById("results_original").appendChild(htmlToElement('<br \>'));
			first_outer = false;
		  }
		  var resultcont = document.getElementById("results_original");
		  resultcont.removeChild(resultcont.childNodes[0]); //Remove the spinner
		  updatePrice();
		})();
	}
	function formatE(price){
		if (price.length < 3){
			return price+"";
		}
		var index = price.length - 2;
		return price.substring(0, index) + "," + price.substring(index);
	}
	function countz(arr, t){
		c = 0;
		for(var i=0;i<arr.length;i++){
			if (arr[i].toLowerCase()===t){
				c = c + 1;
			}
		}
		return c;
	}
	function countC(string, c){
		return (string.match(new RegExp(c, "g")) || []).length
	}
	function toggleB(btn){
		var btns = btn.parentElement;
		var btn1 = btns.querySelector("#btnNew");
		var btn2 = btns.querySelector("#btnBlue");
		var btn3 = btns.querySelector("#btnGreen");
		var all = [btn1, btn2, btn3];
		var card = btns.parentElement.parentElement;
		if(card.data.select){
			card.data.selected = all.indexOf(btn);
			for (b in all){
				var bt = all[b];
				if(!("disabled" in bt.attributes)){
					bt.classList.remove("btn-light");
					bt.classList.remove("btn-primary");
					bt.classList.remove("btn-secondary");
					bt.classList.add("btn-light");
				}
				//"cols" in document.getElementById("input").attributes
			}
			btn.classList.remove("btn-light");
			btn.classList.add("btn-primary");
		}
		updatePrice();
	}
	function updatePrice(){
		var cards = document.getElementsByClassName("card");
		var total = 0;
		var min = 0;
		var max = 0;
		for(i in cards){
			var card = cards[i];
			if(card.data){
				var data = card.data;
				var price = data.prices[data.prices.length-1-Math.min(data.selected, data.prices.length-1)];
				if(!card.data.select){
					price = 0;
				}
				card.querySelector("#card-text3").innerHTML = formatE(price+"")+"€";
				//Style the card nicely
				card.classList.remove("bg-white");
				card.classList.remove("bg-light");
				total += price;
				if(card.data.select){
					var mi = 9999999;
					var ma = 0;
					for(z in data.prices){
						mi = Math.min(mi, data.prices[z]);
						ma = Math.max(ma, data.prices[z]);
					}
					min += mi;
					max += ma;
					card.classList.add("bg-light");
					card.querySelector("#card-img-top").classList.remove("jf-img-disabled");
				}
				else{
					card.classList.add("bg-white");
					card.querySelector("#card-img-top").classList.add("jf-img-disabled");
				}
			}
		}
		var hintInfo = document.getElementById("finalHinta");
		var hintInfoSub = document.getElementById("finalHintaSub");
		hintInfo.innerHTML = "Yhteensä " + formatE(total+"")+"€";
		hintInfoSub.innerHTML = "(" + formatE(min+"") + "€ - " + formatE(max+"") + "€)";
	}
	var b2_originals = {}
	function toggleB2(btn){
		var btns = btn.parentElement;
		var btn1 = btns.querySelector("#btnNew");
		var btn2 = btns.querySelector("#btnBlue");
		var btn3 = btns.querySelector("#btnGreen");
		var all = [btn1, btn2, btn3];
		var card = btns.parentElement.parentElement;
		card.data.select = btn.classList.contains("btn-danger");
		if(btn.classList.contains("btn-danger")){
			btn.classList.remove("btn-danger");
			btn.classList.add("btn-success");
			for (b in all){
				var bt = all[b];
				if(!("disabled" in bt.attributes)){
					//bt.classList.remove("btn-secondary");
					bt.classList.remove("btn-light");
					bt.classList.remove("btn-primary");
					bt.classList.remove("btn-secondary");
					bt.classList = b2_originals[b + btn];
				}
				//"cols" in document.getElementById("input").attributes
			}
		}
		else{
			btn.classList.remove("btn-success");
			btn.classList.add("btn-danger");
			for (b in all){
				var bt = all[b];
				b2_originals[b + btn] = bt.classList + []; //ffs this is just stupid
				if(!("disabled" in bt.attributes)){
					bt.classList.remove("btn-light");
					bt.classList.remove("btn-primary");
					bt.classList.remove("btn-secondary");
					bt.classList.add("btn-secondary");
				}
				//"cols" in document.getElementById("input").attributes
			}
		}
		updatePrice();
	}
	function base64encode(str) {
	  let encode = encodeURIComponent(str).replace(/%([a-f0-9]{2})/gi, (m, $1) => String.fromCharCode(parseInt($1, 16)))
	  return btoa(encode)
	}
	function setColor(card){
		console.log(card.data.image);
		var url = 'https://kirjat-ml.herokuapp.com/api/' + encodeURIComponent("v1_img|" + base64encode(card.data.image));
		console.log(url);
		fetch(url)
		.then(function(response) {
			response.text().then(function(text) {
				doneSetColor(text, card);
			});
		});
	}
	function doneSetColor(b64, card) {
		var img2 = card.querySelector("#card-img-top");
		var img = new Image();
		img.onload = setColorStage2(card, img);
		img.crossOrigin = "anonymous";  // This enables CORS
		img.src = b64 + "";
	}
	function setColorStage2(card, img){
		document.body.appendChild(img);
		var color = getAverageRGB(img);
		console.log(color);
		card.style.background = "rgb(" + color.r, + ", " + color.b + ", " + color.g + ")";
	}
	function addCard(name, conditions, prices, image, data, first) {
		if ('content' in document.createElement('template')) {

			// Instantiate the table with the existing HTML tbody
			// and the row with the template
			var results = document.querySelectorAll("#results");
			var tbody = results[results.length-1];
			var template = document.getElementById('cardTemplate');

			// Clone the new row and insert it into the table
			var clone = template.content.cloneNode(true);
			var td = clone.querySelector("#card-body");
			
			data.selected = 0;
			data.select = true;
			td.parentElement.data = data;
			
			td.querySelector("#card-title").textContent = name;
			var conds = "";
			var lastcond = conditions.length
			for(var i in conditions){
				var append = ", ";
				if (i == lastcond-1){
					append = "";
				}
				conds = conds + conditions[i] + append;
			}
			td.querySelector("#card-text").textContent = conds;
			td.querySelector("#card-text2").textContent = "Max " + formatE(prices[prices.length-1]+"") + "€";
			clone.querySelector("#card-text3").textContent = "" + formatE(prices[0]+"") + "€";
			var img = clone.querySelector("#card-img-top");
			img.src = image;
			//setColor(td.parentElement);
			//var color = getAverageRGB(img);
			//td.parentElement.style.background = "rgb(" + color.r, + ", " + color.b + ", " + color.g + ")";
			
			var btns = clone.querySelector("#buttons");
			var btn1 = btns.querySelector("#btnNew");
			var btn2 = btns.querySelector("#btnBlue");
			var btn3 = btns.querySelector("#btnGreen");
			var btn4 = btns.querySelector("#btnSelect");
			var amount_of_used = countz(conditions, "käytetty");
			if (!conditions.includes("Uusi")){
				btn1.classList.remove("btn-primary");
				btn1.classList.add("btn-secondary");
			}
			if ( amount_of_used < 2){
				btn2.classList.remove("btn-dark");
				btn2.classList.add("btn-secondary");
				btn2.setAttribute("disabled", "");
			}
			if ( amount_of_used < 1){
				btn3.classList.remove("btn-dark");
				btn3.classList.add("btn-secondary");
				btn3.setAttribute("disabled", "");
			}

			tbody.appendChild(clone);
			if(first === false){
				toggleB2(btn4);
				//console.log(btn4);
			}

		} else {
		  // Find another way to add the rows to the table because 
		  // the HTML template element is not supported.
		}
	}
	function htmlToElement(html) {
		var template = document.createElement('template');
		html = html.trim(); // Never return a text node of whitespace as the result
		template.innerHTML = html;
		return template.content.firstChild;
	}
	function linkClean(link){
		return link.replaceAll("ä", "_a_").replaceAll("ö", "_o_").replaceAll("å", "_e_").replaceAll("’", "_c_").replaceAll("\'", "_c_").replaceAll("…", "...");
	}
	function linkUnClean(link){
		return link.replaceAll("_a_", "ä").replaceAll("_o_", "ö").replaceAll("_e_", "å").replaceAll("_c_", "\'");
	}
	function bClean(b){
		return linkClean(b).replaceAll(";", ",").replaceAll("\n", ";");
	}
	function bUnClean(b){
		return linkUnClean(b.replaceAll(";", "\n"));
	}
	function genLink(){
		var val = document.getElementById("input").value;
		var dict = {};
		var cards = document.getElementsByClassName("card");
		for(i in cards){
			var card = cards[i];
			if(card.data){
				var data = card.data;
			}
		}
		var loc = (window.location + "").split("?")[0].replaceAll("?","");
		return loc.substring(0,loc.length-1) + "?" + encodeURIComponent(btoa(bClean(val)));
	}
	function fromLink(link){
		var origin = link.split("?")[1];
		if (origin && origin.length > 1){
			var val = bUnClean(atob(decodeURIComponent(origin)));
			return val;
		}
		return "";
	}
	//"borrowed" from http://jsfiddle.net/xLF38/818/ :)
	function getAverageRGB(imgEl) {
		var blockSize = 5, // only visit every 5 pixels
			defaultRGB = {r:1,g:0,b:0}, // for non-supporting envs
			canvas = document.createElement('canvas'),
			context = canvas.getContext && canvas.getContext('2d'),
			data, width, height,
			i = -4,
			length,
			rgb = {r:0,g:0,b:0},
			count = 0;
			
		if (!context) {
			return defaultRGB;
		}
		
		height = canvas.height = imgEl.naturalHeight || imgEl.offsetHeight || imgEl.height;
		width = canvas.width = imgEl.naturalWidth || imgEl.offsetWidth || imgEl.width;
		
		//width = Math.max(1, Math.floor(width));
		//height = Math.max(1, Math.floor(height));
		
		context.drawImage(imgEl, 0, 0);
		
		try {
			data = context.getImageData(0, 0, width, height);
		} catch(e) {
			/* security error, img on diff domain *///alert('x');
			console.log(e);
			return defaultRGB;
		}
		
		length = data.data.length;
		
		while ( (i += blockSize * 4) < length ) {
			++count;
			rgb.r += data.data[i];
			rgb.g += data.data[i+1];
			rgb.b += data.data[i+2];
		}
		
		// ~~ used to floor values
		rgb.r = ~~(rgb.r/count);
		rgb.g = ~~(rgb.g/count);
		rgb.b = ~~(rgb.b/count);
		
		return rgb;
		
	}

	//clipboardjs
	$( document ).ready(function() {
	
	new ClipboardJS('.btn');
	
	});

	function onEnter(){
		var stuff_from_link = fromLink(window.location + "");
		if(stuff_from_link != ""){
			document.getElementById("input").value = stuff_from_link;
		}
		fillLink();
	}
	onEnter();
</script>
<script src="install_pwa.js"></script>
</footer>
</html>
