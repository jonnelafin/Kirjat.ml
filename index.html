<!DOCTYPE html>
<html>
<head>
	<title>Kirjat.ml</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<meta charset="UTF-8">
	
	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
	
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
</head>
<body>
	<div class="d-flex justify-content-center">
		<h1> Kirjat.ml </h1><br>
	</div>
	<div class="text-center">
		<p style="font-size:92%;" class="text-muted"> MIT-Lisenssin alainen. Domain ja nimi "Kirjat.ml" © Elias Eskelinen 2020. <a href="https://github.com/jonnelafin/Kirjat.ml-simple-frontend/"> Lähdekoodi </a></p>
	</div>
	<div class="d-flex justify-content-center">
		<textarea cols=75 rows=7 placeholder="Bios 1 Elämä ja evoluutio&#10;Geos 1 Maailma muutoksessa&#10;Insights 2&#10;Tekijä Pitkä matematiikka 3&#10;Nos vemos 3" class="" id="input" ></textarea>
	</div>
	<br>
	<div class="d-flex justify-content-center">
		<button class="btn btn-primary" onclick="query()"> Hae </button>
	</div>
	<hr>
	<div class="container-fluid " id="results_original">
	</div>
	<hr>
	<div class="text-center">
		<h3 id="finalHinta"> Yhteensä 0€ <h3/>
		<h4 id="finalHintaSub"> (-) <h4/>
	</div>
</body>
<footer>
<template id="cardTemplate">
	<div class="card text-center col-auto" style="width: 18rem;" data="-1">
	  <img class="card-img-top" src="" alt="Ei kuvaa" id="card-img-top">
	  <div class="card-body" id="card-body">
		<h5 class="card-title" id="card-title">Card title</h5>
		<p class="card-text" id="card-text" style="margin-bottom: 0.1rem;">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
		<p class="card-text" id="card-text2" style="font-size:90%">Max 10€</p>
	  </div>
	  <div class="card-footer">
		<p class="card-text" id="card-text3" style="font-size:120%">10€</p>
		<div class="btn-group mr-2" role="group" aria-label="First group" id="buttons">
			<button type="button" class="btn btn-primary" id="btnNew" onclick="toggleB(this)">Uusi</button>
			<button type="button" class="btn btn-light" id="btnBlue" onclick="toggleB(this)">Sininen</button>
			<button type="button" class="btn btn-light" id="btnGreen" onclick="toggleB(this)">Vihreä</button>
			<button type="button" class="btn btn-danger" id="btnGreen" onclick="toggleB2(this)">-</button>
		</div>
	  </div>
	</div>
</template>
<script>
	var results_max = 5;
	function unclean(err){
		return err.replaceAll("%E4", "ä").replaceAll("%F6", "ö").replaceAll("%E5", "å");
	}
	function query() {
		document.getElementById("results_original").innerHTML = "";
		var val = document.getElementById("input").value;
		var lineC = countC(val, "\n");
		console.log(lineC);
		if(lineC > 0){
			if(val[val.size-1] === "\n"){
				val = val.substring(0, val.size-2);
			}
		}
		console.log(val)
		document.getElementById("input").rows = Math.min(6, lineC) + 1;
		let formData = new FormData();
		formData.append('querym', val);
		(async () => {
		  const rawResponse = await fetch('https://kirjat-ml.herokuapp.com/api/v1', {
			method: 'POST',
			headers: {
			},
			body: formData
		  });
		  const content = await rawResponse.json();

		  var stuff = content;
		  console.log(stuff);
		  for(thing in stuff){
			var cont = stuff[thing]["data"];
			document.getElementById("results_original").appendChild(htmlToElement('<button class="btn collapsed" style="width: 99%;" data-toggle="collapse" data-target="#collapse' + thing + '">▾' + val.split("\n")[thing] + "▾</button>"));
			document.getElementById("results_original").appendChild(htmlToElement('<div class="collapse" id="collapse' + thing + '">'));
			document.getElementById('collapse' + thing + '').appendChild(htmlToElement('<div class="d-flex justify-content-center container-fluid" id="results">'));
			for(booko in cont.slice(0, results_max)){
				var book = cont[booko];
				var name = book["name"];
				var id = book["id"];
				var image = book["image"];
				var link = book["link"];
				var prices = book["prices"];
				var conditions = book["conditions"];
				var price = book["price"];
				if (price != -1){
					addCard(name, conditions, prices, image, book);
				}
			}
			if(stuff[thing]["err"] != ""){
				document.getElementById("results_original").appendChild(htmlToElement('<h4 class="text-center">' + unclean(stuff[thing]["err"]) + '</h4>'));
			}
			document.getElementById("results_original").appendChild(htmlToElement('<br \>'));
		  }
		  updatePrice();
		})();
	}
	function formatE(price){
		if (price.length < 3){
			return price+"";
		}
		var index = price.length - 2;
		return price.substring(0, index) + "," + price.substring(index);
	}
	function countz(arr, t){
		c = 0;
		for(var i=0;i<arr.length;i++){
			if (arr[i]===t){
				c = c + 1;
			}
		}
		return c;
	}
	function countC(string, c){
		return (string.match(new RegExp(c, "g")) || []).length
	}
	function toggleB(btn){
		var btns = btn.parentElement;
		var btn1 = btns.querySelector("#btnNew");
		var btn2 = btns.querySelector("#btnBlue");
		var btn3 = btns.querySelector("#btnGreen");
		var all = [btn1, btn2, btn3];
		var card = btns.parentElement.parentElement;
		if(card.data.select){
			card.data.selected = all.indexOf(btn);
			for (b in all){
				var bt = all[b];
				if(!("disabled" in bt.attributes)){
					bt.classList.remove("btn-light");
					bt.classList.remove("btn-primary");
					bt.classList.remove("btn-secondary");
					bt.classList.add("btn-light");
				}
				//"cols" in document.getElementById("input").attributes
			}
			btn.classList.remove("btn-light");
			btn.classList.add("btn-primary");
		}
		updatePrice();
	}
	function updatePrice(){
		var cards = document.getElementsByClassName("card");
		var total = 0;
		var min = 0;
		var max = 0;
		for(i in cards){
			var card = cards[i];
			if(card.data){
				var data = card.data;
				var price = data.prices[data.prices.length-1-Math.min(data.selected, data.prices.length-1)];
				if(!card.data.select){
					price = 0;
				}
				card.querySelector("#card-text3").innerHTML = formatE(price+"")+"€";
				total += price;
				if(card.data.select){
					var mi = 9999999;
					var ma = 0;
					for(z in data.prices){
						mi = Math.min(mi, data.prices[z]);
						ma = Math.max(ma, data.prices[z]);
					}
					min += mi;
					max += ma;
				}
			}
		}
		var hintInfo = document.getElementById("finalHinta");
		var hintInfoSub = document.getElementById("finalHintaSub");
		hintInfo.innerHTML = "Yhteensä " + formatE(total+"")+"€";
		hintInfoSub.innerHTML = "(" + formatE(min+"") + "€ - " + formatE(max+"") + "€)";
	}
	var b2_originals = {}
	function toggleB2(btn){
		var btns = btn.parentElement;
		var btn1 = btns.querySelector("#btnNew");
		var btn2 = btns.querySelector("#btnBlue");
		var btn3 = btns.querySelector("#btnGreen");
		var all = [btn1, btn2, btn3];
		var card = btns.parentElement.parentElement;
		card.data.select = !btn.classList.contains("btn-danger");
		if(btn.classList.contains("btn-danger")){
			btn.classList.remove("btn-danger");
			btn.classList.add("btn-success");
			for (b in all){
				var bt = all[b];
				b2_originals[b + btn] = bt.classList + []; //ffs this is just stupid
				if(!("disabled" in bt.attributes)){
					bt.classList.remove("btn-light");
					bt.classList.remove("btn-primary");
					bt.classList.remove("btn-secondary");
					bt.classList.add("btn-secondary");
				}
				//"cols" in document.getElementById("input").attributes
			}
				
		}
		else{
			btn.classList.remove("btn-success");
			btn.classList.add("btn-danger");
			for (b in all){
				var bt = all[b];
				if(!("disabled" in bt.attributes)){
					//bt.classList.remove("btn-secondary");
					bt.classList.remove("btn-light");
					bt.classList.remove("btn-primary");
					bt.classList.remove("btn-secondary");
					bt.classList = b2_originals[b + btn];
				}
				//"cols" in document.getElementById("input").attributes
			}
		}
		updatePrice();
	}
	function getQuality(){
		
	}
	function addCard(name, conditions, prices, image, data) {
		if ('content' in document.createElement('template')) {

			// Instantiate the table with the existing HTML tbody
			// and the row with the template
			var results = document.querySelectorAll("#results");
			var tbody = results[results.length-1];
			var template = document.getElementById('cardTemplate');

			// Clone the new row and insert it into the table
			var clone = template.content.cloneNode(true);
			var td = clone.querySelector("#card-body");
			
			data.selected = 0;
			data.select = true;
			td.parentElement.data = data;
			
			td.querySelector("#card-title").textContent = name;
			var conds = "";
			var lastcond = conditions.length
			for(var i in conditions){
				var append = ", ";
				if (i == lastcond-1){
					append = "";
				}
				conds = conds + conditions[i] + append;
			}
			td.querySelector("#card-text").textContent = conds;
			td.querySelector("#card-text2").textContent = "Max " + formatE(prices[0]+"") + "€";
			clone.querySelector("#card-text3").textContent = "" + formatE(prices[0]+"") + "€";
			var img = clone.querySelector("#card-img-top");
			img.src = image;
			
			var btns = clone.querySelector("#buttons");
			var btn1 = btns.querySelector("#btnNew");
			var btn2 = btns.querySelector("#btnBlue");
			var btn3 = btns.querySelector("#btnGreen");
			var amount_of_used = countz(conditions, "Käytetty");
			if (!conditions.includes("Uusi")){
				btn1.classList.remove("btn-primary");
				btn1.classList.add("btn-secondary");
			}
			if ( amount_of_used < 2){
				btn2.classList.remove("btn-dark");
				btn2.classList.add("btn-secondary");
				btn2.setAttribute("disabled", "");
			}
			if ( amount_of_used < 1){
				btn3.classList.remove("btn-dark");
				btn3.classList.add("btn-secondary");
				btn3.setAttribute("disabled", "");
			}

			tbody.appendChild(clone);

		} else {
		  // Find another way to add the rows to the table because 
		  // the HTML template element is not supported.
		}
	}
	function htmlToElement(html) {
		var template = document.createElement('template');
		html = html.trim(); // Never return a text node of whitespace as the result
		template.innerHTML = html;
		return template.content.firstChild;
	}
</script>
</footer>
</html>
